@model ParkingDetails

<br />
@foreach (var floors in ViewBag.AllFloors)
{

	<div class="alert alert-dismissible alert-warning">
		<center>
			&nbsp;<strong> @floors Floor Car Park</strong><br />
		</center>
	</div>



	<div class="container d-flex flex-wrap">
		<div style="display:none;" id="loader"></div>



		@foreach (var parkingSpace in Model.ParkingSpaces)
		{
		
			if (parkingSpace.Floor == floors)
			{
				@if (string.IsNullOrEmpty(parkingSpace.Occupant))
				{
						
						<div class="card text-white bg-success mb-3">
							<div class="card-header"><strong>Slot: </strong>@parkingSpace.SlotNumber</div>
							<div class="card-body">

							@using (Html.BeginForm("Submit", "Home", FormMethod.Post, new { @name = "Form1" }))
							{
								<center>
									@if(@parkingSpace.SlotType == "Car"){
								<img src="https://cdn-icons-png.flaticon.com/512/1048/1048313.png" style="width:100px;height:100px;" />
									}else{
									<img src="https://cdn-icons-png.flaticon.com/512/1048/1048323.png" style="width:100px;height:100px;" />
									}
									<br>
									<strong>@parkingSpace.SlotType</strong>
								</center>


								if(parkingSpace.SlotType == "Car"){
									<h4 class="card-title">@Html.DropDownList(parkingSpace.SlotNumber+"|"+parkingSpace.Floor+"|"+parkingSpace.SlotType, new SelectList(ViewBag.CarList),"", new {id = "ddlOccupant", @class="js-example-responsive js-states form-control" ,style="width:100%;"})</h4>
							}
								else
								{
									<h4 class="card-title">@Html.DropDownList(parkingSpace.SlotNumber+"|"+parkingSpace.Floor+"|"+parkingSpace.SlotType, new SelectList(ViewBag.MotorBikeList),"", new {id = "ddlOccupant", @class="js-example-responsive js-states form-control",style="width:100%;"})</h4>
								}

								<input type="hidden" id="@ViewBag.Floor" name="thisfloor">
								

								@Html.Hidden("slotnumber", null , new{id = "hfSlotNumber"})
								@Html.Hidden("Occupant", null , new{id = "hfSelectedOccupant"})
								@Html.Hidden("floor", ViewBag.Floor, new{id = "hfFloor"})
								@Html.Hidden("vehicleType", null , new{id = "hfVehicleType"})
								}
								

							</div>
						</div>				
				}
				else
				{
					@using (Html.BeginForm("FreeUp", "Home", FormMethod.Post, new { @name = "Form2" }))
					{
						<div class="card text-white bg-danger mb-3">
							<div class="card-header"><strong>Slot: </strong>@parkingSpace.SlotNumber
								
							</div>
							<div class="card-body">
								<p><strong>Occupant: </strong>@parkingSpace.Occupant</p>
								@foreach (var occupantDetails in Model.Occupants)
								{
									if (occupantDetails.FullName == parkingSpace.Occupant)
									{
										var thisDate = parkingSpace.DateTime.ToDateTime();
										var convertedTime = thisDate.ToLocalTime();
										<p><strong>Plate Number: </strong>@occupantDetails.PlateNumber</p>
										<h6><strong>Contact Number: </strong>@occupantDetails.ContactNumber</h6>
										<h6><strong>Vehicle: </strong>@occupantDetails.Vehicle</h6>
										<h6><strong>Date: </strong>@convertedTime.ToString("ddd, dd MMM yyy")</h6>
										<h6><strong>Time: </strong>@convertedTime.ToString("hh:mm tt")</h6>
									}
								}


								<button type="button" class="btn btn-secondary" name="@parkingSpace.SlotNumber|@parkingSpace.Floor|@parkingSpace.SlotType" id="ddlFreeUp" stlye="width:10rem;">Free Up</button>
								
								<input type="hidden" id="@ViewBag.Floor" name="thisfloor">

								@Html.Hidden("slotnumber", null , new{id = "hfSlotNumberFreeUp"})
								@Html.Hidden("Occupant", null , new{id = "hfSelectedOccupantFreeUp"})
								@Html.Hidden("floor", null , new{id = "hfFloorFreeUp"})
								@Html.Hidden("vehicleType", null , new{id = "hfVehicleTypeFreeUp"})
							


							</div>
						</div>

					}
				}
			
			}

		}


	</div>
}

<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="https://rawgit.com/select2/select2/4.0.5/dist/js/select2.full.min.js"></script>
							
<script type="text/javascript">
	$('.js-example-responsive').select2({
		placeholder: "Available",
		allowClear: true
	});
	
	var go;
	$("body").on("change", "#ddlOccupant", function () {
		
					var floorAndSlot = this.getAttribute("name");
					const floorAndSlotArr = floorAndSlot.split("|");
					var slot = floorAndSlotArr[0];
					var floor = floorAndSlotArr[1];
					var vehicletype = floorAndSlotArr[2];

					$("#hfSelectedOccupant").val($(this).find("option:selected").text());
					$("#hfSlotNumber").val(slot);
					$("#hfVehicleType").val(vehicletype);
					var elements = document.getElementsByName('thisfloor');
					var id = elements[0].getAttribute('id');
					$("#hfFloor").val(floor);

					go = setTimeout(showPage);

		
	
	});



	$("body").on("click", "#ddlFreeUp", function () {

		swal({
		  title: "Are you sure?",
		  text: "you want to free up this parking space?",
		  icon: "warning",
		  buttons: true,
		  dangerMode: true,
		})
		.then((willDelete) => {
		  if (willDelete) {
			  var floorAndSlot = this.getAttribute("name");
				const floorAndSlotArr = floorAndSlot.split("|");
				var slot = floorAndSlotArr[0];
				var floor = floorAndSlotArr[1];
				var vehicletype = floorAndSlotArr[2];

				$("#hfSelectedOccupantFreeUp").val($(this).value);
				$("#hfSlotNumberFreeUp").val(slot);
				$("#hfVehicleTypeFreeUp").val(vehicletype);
				$("#hfFloorFreeUp").val(floor);
					go = setTimeout(freeUpPage);
		  } else {
			swal("Changes not saved!");
		  }
		});
	});


	function showPage() {
		
		swal({
				title: "Occupying this slot...",
				text:" ",
                icon: "https://cdn.dribbble.com/users/2245289/screenshots/6835230/dribbble.gif",
                buttons: false,      
                closeOnClickOutside: false,
                timer: 90000,
                //icon: "success"
            });

		document.forms["Form1"].submit();
	}
	function freeUpPage() {
		swal({
				title: "Freeing up this slot...",
				text:" ",
                icon: "https://cdn.dribbble.com/users/2245289/screenshots/6835230/dribbble.gif",
                buttons: false,      
                closeOnClickOutside: false,
                timer: 90000,
                //icon: "success"
            });

		document.forms["Form2"].submit();
	}


</script>

@if (TempData["Message"] != null)
{
	<script >
		$(function () {
			if("@TempData["Message"]" == "Success"){
			swal("@TempData["Message"]", "", "success");
			}else{
				swal("Oops!", "@TempData["Message"]", "error");
			}
		});
	</script>
}

